<div class="container">
  <nav class="main-nav">
    <%= link_to "Forms", forms_path %>
    <%= link_to "Sections", sections_path %>
    <%= link_to "Questions", questions_path %>
    <%= link_to "Answers", answers_path %>
    <%= link_to "Responses", responses_path %>
    <%= link_to "Metrics", metrics_path %>
    <%= link_to "Dashboards", dashboards_path %>
    <%= link_to "Logout", logout_path, data: { "turbo-method": :delete } %>
  </nav>

  <h1>New Metric</h1>

  <%= link_to "← Back to Metrics", metrics_path, class: "back-link" %>

  <div class="card">
    <%= form_with model: @metric, local: true do |form| %>
  <% if @metric.errors.any? %>
    <div class="error-messages">
      <h4><%= pluralize(@metric.errors.count, "error") %> prohibited this metric from being saved:</h4>
      <ul>
        <% @metric.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= form.label :name %>
    <%= form.text_field :name, placeholder: "Optional: Enter a name for this metric" %>
  </div>

  <div class="field">
    <%= form.label :function, "Function" %>
    <%= form.select :function, [['Answer', 'answer'], ['Sum', 'sum'], ['Average', 'average'], ['Difference', 'difference'], ['Count', 'count']], { prompt: 'Select function' }, { required: true } %>
  </div>
  
  <div class="field question-sources" style="display: none;">
    <%= form.label :question_ids, "Questions" %>
    <%= form.collection_check_boxes :question_ids, @questions, :id, :id, { checked: @metric.question_ids }, { class: 'question-checkbox' } do |b| %>
      <div class="checkbox-item">
        <%= b.check_box %>
        <%= b.label do %>
          <%= "#{b.object.name} (#{b.object.question_type})" %>
        <% end %>
      </div>
    <% end %>
  </div>
  
  <div class="field metric-sources" style="display: none;">
    <%= form.label :child_metric_ids, "Metrics" %>
    <%= form.collection_check_boxes :child_metric_ids, @metrics, :id, :id, { checked: @metric.child_metric_ids }, { class: 'metric-checkbox' } do |b| %>
      <div class="checkbox-item">
        <%= b.check_box %>
        <%= b.label do %>
          <%= "#{b.object.display_name} - #{b.object.function&.capitalize || 'Unknown'} (#{b.object.resolution}/#{b.object.width})" %>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="field">
    <%= form.label :resolution %>
    <%= form.select :resolution, [['Day', 'day'], ['Week', 'week'], ['Month', 'month']], { prompt: 'Select resolution' }, { required: true } %>
  </div>

  <div class="field">
    <%= form.label :width %>
    <%= form.select :width, [['Daily', 'daily'], ['Weekly', 'weekly'], ['Monthly', 'monthly'], ['90 Days', '90_days'], ['Yearly', 'yearly'], ['All Time', 'all_time']], { prompt: 'Select width' }, { required: true } %>
  </div>


      <div class="actions">
        <%= form.submit "Create Metric" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const functionSelect = document.querySelector('#metric_function');
    const questionSources = document.querySelector('.question-sources');
    const metricSources = document.querySelector('.metric-sources');
    
    if (functionSelect) {
      functionSelect.addEventListener('change', function() {
        if (this.value === 'answer') {
          questionSources.style.display = 'block';
          metricSources.style.display = 'none';
        } else if (['sum', 'average', 'difference', 'count'].includes(this.value)) {
          questionSources.style.display = 'none';
          metricSources.style.display = 'block';
        } else {
          questionSources.style.display = 'none';
          metricSources.style.display = 'none';
        }
      });
    }
  });
</script>