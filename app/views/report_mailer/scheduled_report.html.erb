<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      line-height: 1.6; 
      color: #333; 
      max-width: 600px; 
      margin: 0 auto; 
      padding: 1rem; 
    }
    .card {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card h3 {
      margin: 0 0 1rem 0;
      font-size: 1.1rem;
    }
    .alert-progress {
      display: flex;
      align-items: center;
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
    }
    .alert-value {
      width: 60px;
      text-align: center;
      font-weight: bold;
    }
    .progress-bar-container {
      flex: 1;
      margin: 0 0.75rem;
      position: relative;
    }
    .progress-bar {
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      transition: all 0.3s ease;
    }
    .alert-threshold {
      width: 80px;
      text-align: center;
      color: #666;
      font-size: 0.8rem;
    }
    .alert-name {
      flex: 2;
      margin-left: 0.75rem;
    }
    .alert-name a {
      text-decoration: none;
      font-weight: bold;
    }
    .alert-message-section {
      margin-bottom: 1rem;
      padding: 0.75rem;
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 4px;
    }
    .alert-message-title {
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #856404;
    }
    .alert-message-content {
      color: #856404;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .metric-item {
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 0.75rem;
    }
    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .metric-name {
      margin: 0;
      font-size: 0.9rem;
    }
    .metric-name a {
      text-decoration: none;
      color: inherit;
    }
    .metric-value {
      font-weight: bold;
      font-size: 0.9rem;
    }
    .metric-graph {
      margin-top: 0.5rem;
    }
    .footer {
      border-top: 1px solid #ddd;
      padding-top: 20px;
      margin-top: 30px;
      font-size: 14px;
      color: #666;
    }
    .btn {
      display: inline-block;
      padding: 8px 16px;
      background-color: #007cba;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }
    h1 {
      text-align: center;
      margin: 0 0 2rem 0;
      font-size: 1.5rem;
    }
    .report-subtitle {
      text-align: center;
      margin: 0.5rem 0 0 0;
      color: #666;
      font-size: 0.9rem;
    }
    /* Single column on email to ensure compatibility */
    @media screen and (max-width: 600px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Report Title -->
  <div style="text-align: center; margin-bottom: 2rem;">
    <h1><%= @report.name || "Report ##{@report.id}" %></h1>
    <p class="report-subtitle">
      <%= @report.interval_type.capitalize %> at <%= @report.time_of_day&.strftime("%H:%M") || "Not set" %>
    </p>
  </div>

  <!-- Alerts Section -->
  <% if @report.alerts.any? %>
    <div class="card">
      <h3>Alerts (<%= @report.alerts.count %>)</h3>
      
      <% @report.alerts.each do |alert| %>
        <% progress_info = alert.activation_progress %>
        <% progress_percent = (progress_info[:progress] * 100).round %>
        <% 
          exceeding_count = progress_info[:exceeding_count]
          delay = alert.delay
          
          if progress_percent >= 100
            bar_color = "#dc3545" # red
          elsif delay > 1 && exceeding_count == (delay - 1)
            # Special case: 1 day away from activation (but not for delay=1 alerts)
            bar_color = "#ffc107" # yellow
          elsif progress_percent >= 75
            bar_color = "#ffc107" # yellow
          else
            bar_color = "#28a745" # green
          end
        %>
        
        <div class="alert-progress">
          <!-- Column 1: Latest Value -->
          <div class="alert-value">
            <% 
              # Get the latest value from the metric's series data
              series_data = alert.metric.series
              latest_value = series_data.any? ? series_data.last[1] : nil
            %>
            <%= latest_value ? latest_value.round(2) : "N/A" %>
          </div>
          
          <!-- Column 2: Progress Bar -->
          <div class="progress-bar-container">
            <div class="progress-bar">
              <% 
                # For 0% progress, show full green bar. Otherwise show actual progress.
                display_width = progress_percent == 0 ? 100 : progress_percent
              %>
              <div class="progress-bar-fill" style="background-color: <%= bar_color %>; width: <%= display_width %>%;"></div>
            </div>
          </div>
          
          <!-- Column 3: Threshold and Delay Combined -->
          <div class="alert-threshold">
            <%= alert.direction == "above" ? "↑" : "↓" %><%= alert.threshold %> / <%= alert.delay %>d
          </div>
          
          <!-- Column 4: Alert Name -->
          <div class="alert-name">
            <a href="<%= alert_url(alert) %>" style="color: <%= bar_color %>;">
              <%= alert.display_name %>
            </a>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Alert Messages Section (for activated alerts only) -->
  <% activated_alerts = @report.alerts.select(&:activated?) %>
  <% activated_alerts_with_messages = activated_alerts.select { |alert| alert.message.present? } %>
  <% if activated_alerts_with_messages.any? %>
    <div class="card">
      <h3>Alert Messages</h3>
      
      <% activated_alerts_with_messages.each do |alert| %>
        <div class="alert-message-section">
          <div class="alert-message-title">
            <%= alert.display_name %>
          </div>
          <div class="alert-message-content">
            <%= simple_format(alert.message) %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Metrics Section -->
  <% if @report.metrics.any? %>
    <div class="card">
      <h3>Metrics (<%= @report.metrics.count %>)</h3>
      
      <!-- 2-column grid layout -->
      <div class="metrics-grid">
        <% @report.metrics.each do |metric| %>
          <% series_data = metric.series %>
          <div class="metric-item">
            <!-- Metric name and latest value -->
            <div class="metric-header">
              <h4 class="metric-name">
                <a href="<%= metric_url(metric) %>"><%= metric.display_name %></a>
              </h4>
              <% if series_data.any? %>
                <span class="metric-value"><%= series_data.last[1]&.round(2) %></span>
              <% else %>
                <span class="metric-value" style="color: #999;">N/A</span>
              <% end %>
            </div>
            
            <!-- Compact line graph -->
            <div class="metric-graph">
              <% if series_data.any? %>
                <%
                  # Prepare data for SVG
                  values = series_data.map { |time, value| value || 0 }
                  next if values.empty?
                  
                  # Graph dimensions (smaller for 2-column layout)
                  width = 160
                  height = 35
                  padding = 3
                  
                  # Calculate scale
                  min_val = values.min
                  max_val = values.max
                  val_range = max_val - min_val
                  val_range = 1 if val_range == 0  # Avoid division by zero
                  
                  # Generate points for polyline
                  points = values.each_with_index.map do |val, i|
                    x = padding + (i.to_f / (values.length - 1)) * (width - 2 * padding)
                    y = height - padding - ((val - min_val).to_f / val_range) * (height - 2 * padding)
                    "#{x.round(1)},#{y.round(1)}"
                  end.join(" ")
                %>
                <svg width="<%= width %>" height="<%= height %>" style="border: 1px solid #e0e0e0; background: #f9f9f9;">
                  <polyline points="<%= points %>" 
                           fill="none" 
                           stroke="#007bff" 
                           stroke-width="1.5" 
                           stroke-linecap="round" 
                           stroke-linejoin="round"/>
                  <!-- Data points as small circles -->
                  <% values.each_with_index do |val, i| %>
                    <% 
                      x = padding + (i.to_f / (values.length - 1)) * (width - 2 * padding)
                      y = height - padding - ((val - min_val).to_f / val_range) * (height - 2 * padding)
                    %>
                    <circle cx="<%= x.round(1) %>" cy="<%= y.round(1) %>" r="1.5" fill="#007bff"/>
                  <% end %>
                </svg>
              <% else %>
                <div style="font-size: 0.8rem; color: #999; font-style: italic;">No data available</div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="footer">
    <p style="text-align: center;">
      <strong>Built for tracking the patterns that matter to you.</strong>
    </p>
    <hr style="margin: 15px 0;">
    <p style="text-align: center;">
      <small>
        <a href="<%= root_url %>">Open Routine Tracker</a> | 
        <a href="<%= reports_url %>">Manage Reports</a>
      </small>
    </p>
  </div>
</body>
</html>