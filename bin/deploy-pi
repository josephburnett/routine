#!/bin/bash

#
# Deploy to Raspberry Pi using direct SSH push (no Docker registry)
#
# This script:
# 1. Builds the Docker image locally for arm/v7 architecture
# 2. Pushes the image directly to the Pi via SSH using docker-pussh (unregistry)
# 3. Deploys the container on the Pi using Kamal
#
# Requirements:
# - docker-pussh installed locally (see README)
# - SSH access to Pi via Tailscale (joe@home.gila-lionfish.ts.net)
# - User joe must be in docker group on Pi
# - 1Password CLI signed in (for secrets)
#

set -e

# Check if 1Password CLI is signed in
echo "ğŸ” Checking 1Password CLI authentication..."
if ! op whoami &> /dev/null; then
  echo ""
  echo "âŒ Error: You are not signed in to 1Password CLI"
  echo ""
  echo "Please sign in first:"
  echo "  eval \$(op signin)"
  echo ""
  exit 1
fi
echo "âœ… 1Password CLI authenticated"
echo ""

# Get the git commit hash for image tagging (matches Kamal default)
VERSION=$(git rev-parse --short HEAD)
IMAGE_NAME="localhost/routine:${VERSION}"

# Note: We build as localhost/routine but Kamal expects just "routine"
# because it will prepend the registry server (localhost) automatically

echo "ğŸ”¨ Building image for arm/v7 (version: ${VERSION})..."
docker buildx build --platform linux/arm/v7 -t "${IMAGE_NAME}" --load .

echo ""
echo "ğŸ“¤ Pushing image to Pi via SSH (docker pussh)..."
docker pussh "${IMAGE_NAME}" joe@home.gila-lionfish.ts.net

echo ""
echo "ğŸš€ Deploying on Pi..."
kamal app boot --version="${VERSION}"

echo ""
echo "âœ… Deployment complete!"
echo "ğŸ  Your app is now available at: http://home.gila-lionfish.ts.net"
