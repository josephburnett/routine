#!/bin/bash

#
# Deploy to RTB server using direct SSH push (no Docker registry)
#
# This script:
# 1. Builds the Docker image locally for amd64 architecture
# 2. Pushes the image directly to RTB via SSH using docker-pussh (unregistry)
# 3. Deploys the container on RTB using Kamal
#
# Requirements:
# - docker-pussh installed locally (see README)
# - SSH access to RTB via Tailscale (joe@rtb.gila-lionfish.ts.net)
# - SSH key at ~/.ssh/rtb.local
# - User joe must be in docker group on RTB
# - 1Password CLI signed in (for secrets)
#

set -e

# Check if 1Password CLI is signed in
echo "üîê Checking 1Password CLI authentication..."
if ! op whoami &> /dev/null; then
  echo ""
  echo "‚ùå Error: You are not signed in to 1Password CLI"
  echo ""
  echo "Please sign in first:"
  echo "  eval \$(op signin)"
  echo ""
  exit 1
fi
echo "‚úÖ 1Password CLI authenticated"
echo ""

# Get the git commit hash for image tagging (matches Kamal default)
VERSION=$(git rev-parse --short HEAD)
IMAGE_NAME="localhost/routine:${VERSION}"

# Note: We build as localhost/routine but Kamal expects just "routine"
# because it will prepend the registry server (localhost) automatically

echo "üî® Building image for amd64 (version: ${VERSION})..."
docker buildx build --platform linux/amd64 -t "${IMAGE_NAME}" --load .

echo ""
echo "üì§ Pushing image to RTB via SSH (docker pussh)..."
docker pussh -i ~/.ssh/rtb.local "${IMAGE_NAME}" joe@rtb.gila-lionfish.ts.net

echo ""
echo "üöÄ Deploying on RTB..."
kamal app boot --version="${VERSION}"

echo ""
echo "‚úÖ Deployment complete!"
echo "üè† Your app is now available at: http://rtb.gila-lionfish.ts.net:10001"
